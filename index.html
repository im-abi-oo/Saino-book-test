<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
  <title>متقلب - Chapter 1 | Apex Reader</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    :root {
      --primary: #00f2ff;
      --bg: #050508;
      --panel: rgba(13, 13, 18, 0.98);
      --manga-w: 800px;
    }
    
    * { 
      box-sizing: border-box; 
      scrollbar-width: none; 
      -webkit-tap-highlight-color: transparent;
    }
    *::-webkit-scrollbar { display: none; }

    body { 
      background-color: var(--bg); 
      color: #fff; 
      font-family: 'Vazirmatn', sans-serif; 
      margin: 0;
      overflow: hidden;
    }

    /* سیستم رندر بدون درز */
    #render-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      background: var(--bg);
      line-height: 0;
    }
    
    .page-frame {
      width: 100%;
      max-width: var(--manga-w);
      display: block;
      margin: 0;
      padding: 0;
      line-height: 0;
    }

    .manga-img {
      width: 100%;
      height: auto;
      display: block;
      margin: 0;
      padding: 0;
      opacity: 0;
      transition: opacity 0.5s ease;
      will-change: filter;
      transform: translateZ(0);
    }

    /* فیلترهای پیشرفته - قابلیت ترکیب */
    .f-hd-low { filter: contrast(1.1) saturate(1.1) brightness(1.05); }
    .f-hd-high { filter: contrast(1.25) saturate(1.2) brightness(1.15); }
    .f-night { filter: sepia(0.6) brightness(0.6) hue-rotate(170deg); }
    .f-warm { filter: sepia(0.4) saturate(1.4); }
    .f-bw { filter: grayscale(1); }
    .f-inverted { filter: invert(1); }
    .f-noir { filter: grayscale(1) contrast(1.6) brightness(0.8); }
    .f-sepia { filter: sepia(1); }

    /* UI Dynamics */
    .hud-element { transition: all 0.6s cubic-bezier(0.2, 1, 0.2, 1); }
    .hidden-ui { opacity: 0; pointer-events: none; }
    .hidden-top { transform: translateY(-120%); }
    .hidden-bot { transform: translateY(120%); }

    .glass { 
      background: var(--panel); 
      backdrop-filter: blur(30px); 
      border: 1px solid rgba(255,255,255,0.1); 
    }
    
    .btn-main { 
      @apply flex items-center justify-center rounded-2xl transition-all duration-300 active:scale-90 outline-none;
    }

    /* استایل دکمه‌های فعال */
    .btn-active-cyan {
      @apply bg-cyan-500/20 text-cyan-400 border-cyan-500/40 shadow-[0_0_20px_rgba(0,242,255,0.2)] !important;
    }

    .apex-slider {
      -webkit-appearance: none;
      height: 6px;
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      width: 100%;
    }
    .apex-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; height: 20px;
      background: var(--primary);
      border-radius: 50%;
      box-shadow: 0 0 12px var(--primary);
      cursor: pointer;
    }

    @media (max-width: 640px) {
      :root { --manga-w: 100vw; }
      .bottom-panel-container { @apply gap-3 p-3; }
      .btn-main { @apply p-3.5; }
    }
  </style>
</head>
<body>

  <!-- هدر -->
  <header id="ui-top" class="fixed top-0 inset-x-0 z-[100] p-4 hud-element">
    <div class="max-w-5xl mx-auto flex items-center justify-between glass p-4 rounded-[2.2rem]">
      <div class="flex items-center gap-4">
        <button onclick="window.location.href='/'" class="btn-main p-3 bg-white/5 text-zinc-400 hover:text-white">
          <i data-lucide="home" class="w-5 h-5"></i>
        </button>
        <div>
          <h1 class="text-[10px] font-black uppercase text-zinc-500 tracking-widest">I Will Steal Your Place</h1>
          <p class="text-sm font-bold text-white">متقلب</p>
        </div>
      </div>
      <div class="text-left border-r border-white/10 pr-6">
          <span class="text-[10px] text-zinc-500 block font-black uppercase">PAGE</span>
          <span class="text-lg font-mono text-cyan-400 font-bold tracking-tighter">
            <span id="pg-current">01</span><span class="text-zinc-700 mx-1">/</span><span id="pg-total">00</span>
          </span>
      </div>
    </div>
  </header>

  <!-- نمایشگر اصلی -->
  <main id="main-viewport" class="w-full h-screen overflow-y-auto scroll-smooth" onclick="handleInteractions()">
    <div id="render-area"></div>
  </main>

  <!-- کنترلر پایین -->
  <footer id="ui-bottom" class="fixed bottom-0 inset-x-0 z-[100] p-6 hud-element flex flex-col items-center gap-6 pointer-events-none">
    
    <div class="w-full max-w-xl h-1 bg-white/5 rounded-full overflow-hidden pointer-events-auto shadow-inner">
      <div id="prog-fill" class="h-full bg-cyan-400 shadow-[0_0_15px_#00f2ff] transition-all duration-300" style="width: 0%"></div>
    </div>

    <div class="bottom-panel-container flex items-center gap-5 glass p-4 rounded-[3rem] shadow-2xl pointer-events-auto">
      <button id="next-ch" class="btn-main p-4 text-zinc-500 hover:text-white"><i data-lucide="chevron-right"></i></button>
      
      <div class="flex items-center gap-4 px-4 border-x border-white/10">
        <button id="auto-btn" onclick="event.stopPropagation(); toggleAutoScroll();" class="btn-main p-4 text-zinc-500 hover:text-cyan-400 border border-transparent">
          <i data-lucide="play" id="auto-icon" class="w-6 h-6"></i>
        </button>
        
        <button onclick="event.stopPropagation(); toggleChapters();" class="btn-main p-4 text-zinc-500 hover:text-white">
          <i data-lucide="layout-grid" class="w-6 h-6"></i>
        </button>

        <!-- تنظیمات اصلی -->
        <button onclick="event.stopPropagation(); toggleSettings();" class="w-16 h-16 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-full text-white shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center justify-center">
          <i data-lucide="sliders" class="w-7 h-7"></i>
        </button>

        <button id="mode-btn" onclick="event.stopPropagation(); toggleReadMode();" class="btn-main p-4 text-zinc-500 hover:text-white border border-transparent">
          <i data-lucide="scroll" id="mode-icon" class="w-6 h-6"></i>
        </button>
        
        <button onclick="event.stopPropagation(); view.scrollTo({top:0, behavior:'smooth'})" class="btn-main p-4 text-zinc-500 hover:text-white">
          <i data-lucide="arrow-up" class="w-6 h-6"></i>
        </button>
      </div>

      <button id="prev-ch" class="btn-main p-4 text-zinc-500 hover:text-white"><i data-lucide="chevron-left"></i></button>
    </div>
  </footer>

  <!-- پنل تنظیمات -->
  <div id="settings-panel" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 bg-black/95 backdrop-blur-md" onclick="toggleSettings()">
    <div class="glass w-full max-w-sm p-8 space-y-8 rounded-[3rem] border border-white/10" onclick="event.stopPropagation()">
      <div class="flex justify-between items-center border-b border-white/5 pb-5">
        <h2 class="text-xl font-black text-white flex items-center gap-3">
          <i data-lucide="settings-2" class="text-cyan-400"></i> تنظیمات خواندن
        </h2>
        <button onclick="resetSettings()" class="flex items-center gap-2 text-[10px] font-black text-rose-500 hover:bg-rose-500/10 px-4 py-2 rounded-2xl transition-all">
          <i data-lucide="rotate-ccw" class="w-3 h-3"></i> بازنشانی کامل
        </button>
      </div>

      <div class="space-y-7">
        <div class="space-y-5">
          <div class="space-y-3">
            <div class="flex justify-between text-[11px] font-bold text-zinc-500"><span>عرض تصاویر</span> <span id="val-width" class="text-cyan-400 font-mono">800px</span></div>
            <input type="range" min="400" max="1400" step="50" id="range-width" class="apex-slider">
          </div>
          <div class="space-y-3">
            <div class="flex justify-between text-[11px] font-bold text-zinc-500"><span>سرعت اسکرول خودکار</span> <span id="val-speed" class="text-cyan-400 font-mono">2x</span></div>
            <input type="range" min="0.5" max="25" step="0.5" id="range-speed" class="apex-slider">
          </div>
        </div>

        <!-- فیلترهای چندگانه -->
        <div class="grid grid-cols-3 gap-3">
          <button onclick="setFilter('bw')" id="btn-bw" class="p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 transition-all">B&W</button>
          <button onclick="setFilter('night')" id="btn-night" class="p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 transition-all">شب</button>
          <button onclick="setFilter('warm')" id="btn-warm" class="p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 transition-all">گرم</button>
          <button onclick="setFilter('noir')" id="btn-noir" class="p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 transition-all">نوآر</button>
          <button onclick="setFilter('sepia')" id="btn-sepia" class="p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 transition-all">سپیا</button>
          <button onclick="setFilter('inverted')" id="btn-inverted" class="p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 transition-all">وارونه</button>
        </div>

        <div class="bg-zinc-900/50 p-5 rounded-[2rem] border border-white/5 space-y-4">
           <span class="text-[10px] text-zinc-500 font-black uppercase block text-center tracking-widest">ارتقای بافت تصویر (HD)</span>
           <div class="flex p-1 bg-black/40 rounded-2xl gap-1">
             <button onclick="updateHD('off')" id="hd-off" class="flex-1 py-2 text-[10px] font-bold rounded-xl transition-all">OFF</button>
             <button onclick="updateHD('low')" id="hd-low" class="flex-1 py-2 text-[10px] font-bold rounded-xl transition-all">LOW</button>
             <button onclick="updateHD('high')" id="hd-high" class="flex-1 py-2 text-[10px] font-bold rounded-xl transition-all">HIGH</button>
           </div>
        </div>
      </div>
    </div>
  </div>

  <!-- لیست چپترها -->
  <aside id="ch-drawer" class="fixed inset-y-0 right-0 w-80 glass z-[150] translate-x-full transition-transform duration-500 flex flex-col border-l border-white/10">
    <div class="p-8 border-b border-white/5 bg-black/20">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-black text-white">لیست چپترها</h3>
        <button onclick="toggleChapters()" class="p-2 text-zinc-500 hover:text-white"><i data-lucide="x"></i></button>
      </div>
      <div class="relative">
        <input type="text" id="ch-search" placeholder="جستجوی چپتر..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-xs outline-none focus:ring-1 focus:ring-cyan-500 transition-all">
      </div>
    </div>
    <div id="ch-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
  </aside>

  <script>
    const REMOTE = {"series_name_en": "I Will Steal Your Place", "series_name_fa": "متقلب", "current_chapter": {"chapterNumber": 1, "chapterTitle": "مدرسه جدید", "totalPages": 18, "imageLinks": "https://cdne.megaman-server.ir/564//I_Will_Steal_Your_Place/1/{i}.webp"}, "chaptersList": [{"chapterNumber": 1, "chapterTitle": "مدرسه جدید", "chapterLink": "https://im-abi-oo.github.io/Saino-book-test/"}]}; // Injectable
    const DEFAULT_STATE = {
      width: 800, speed: 2, hd: 'off', filters: [], mode: 'webtoon'
    };

    let state = JSON.parse(localStorage.getItem('apex_v6_prefs')) || {...DEFAULT_STATE};
    let isAuto = false, timer, uiVisible = true;
    const view = document.getElementById('main-viewport');
    const area = document.getElementById('render-area');

    function saveState() {
      localStorage.setItem('apex_v6_prefs', JSON.stringify(state));
    }

    function start() {
      if (!REMOTE.current_chapter) return;
      renderPages();
      initChapters();
      bindEvents();
      syncUI();
      applyVisuals();
      lucide.createIcons();
    }

    function renderPages() {
      const { totalPages, imageLinks } = REMOTE.current_chapter;
      document.getElementById('pg-total').textContent = String(totalPages).padStart(2, '0');
      area.innerHTML = '';
      for (let i = 0; i < totalPages; i++) {
        const frame = document.createElement('div');
        frame.className = 'page-frame';
        const img = document.createElement('img');
        img.className = 'manga-img';
        img.dataset.src = imageLinks.replace('{i}', i);
        frame.appendChild(img);
        area.appendChild(frame);
        observer.observe(frame);
      }
    }

    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target.querySelector('img');
          if (img && !img.src) {
            img.src = img.dataset.src;
            img.onload = () => img.style.opacity = '1';
          }
          const idx = Array.from(area.children).indexOf(e.target) + 1;
          document.getElementById('pg-current').textContent = String(idx).padStart(2, '0');
          document.getElementById('prog-fill').style.width = `${(idx / area.children.length) * 100}%`;
        }
      });
    }, { threshold: 0.1, rootMargin: '1500px' });

    function applyVisuals() {
      requestAnimationFrame(() => {
        document.documentElement.style.setProperty('--manga-w', state.width + 'px');
        
        const filterClasses = state.filters.map(f => `f-${f}`).join(' ');
        const hdClass = state.hd !== 'off' ? `f-hd-${state.hd}` : '';

        document.querySelectorAll('.manga-img').forEach(img => {
          img.className = `manga-img ${hdClass} ${filterClasses}`;
        });

        // بروزرسانی آیکون حالت خواندن
        const modeIcon = document.getElementById('mode-icon');
        const modeBtn = document.getElementById('mode-btn');
        if(modeIcon) modeIcon.setAttribute('data-lucide', state.mode === 'book' ? 'book-open' : 'scroll');
        if(modeBtn) modeBtn.classList.toggle('btn-active-cyan', state.mode === 'book');
        
        // استایل دکمه فیلترها (چندتایی)
        ['bw','night','warm','noir','sepia','inverted'].forEach(f => {
          const btn = document.getElementById(`btn-${f}`);
          if (btn) {
            if (state.filters.includes(f)) {
              btn.className = 'p-3 rounded-2xl border border-cyan-500/50 bg-cyan-500/20 text-[10px] font-black text-cyan-400 shadow-[0_0_15px_rgba(0,242,255,0.2)]';
            } else {
              btn.className = 'p-3 rounded-2xl border border-white/5 bg-white/5 text-[10px] font-black text-zinc-500 hover:text-white transition-all';
            }
          }
        });

        // استایل HD
        ['off','low','high'].forEach(v => {
          const btn = document.getElementById(`hd-${v}`);
          if (btn) {
            if (state.hd === v) {
              btn.className = 'flex-1 py-2 text-[10px] font-bold rounded-xl bg-cyan-500 text-black shadow-lg shadow-cyan-500/40';
            } else {
              btn.className = 'flex-1 py-2 text-[10px] font-bold rounded-xl text-zinc-600 hover:text-zinc-200';
            }
          }
        });
        
        lucide.createIcons();
      });
    }

    function resetSettings() {
      state = JSON.parse(JSON.stringify(DEFAULT_STATE));
      syncUI();
      applyVisuals();
      saveState();
    }

    function bindEvents() {
      document.getElementById('range-width').oninput = e => {
        state.width = e.target.value;
        document.getElementById('val-width').textContent = state.width + 'px';
        applyVisuals(); saveState();
      };
      document.getElementById('range-speed').oninput = e => {
        state.speed = e.target.value;
        document.getElementById('val-speed').textContent = state.speed + 'x';
        saveState();
      };
    }

    function syncUI() {
      document.getElementById('range-width').value = state.width;
      document.getElementById('range-speed').value = state.speed;
      document.getElementById('val-width').textContent = state.width + 'px';
      document.getElementById('val-speed').textContent = state.speed + 'x';
    }

    function handleInteractions() {
      if (isAuto) { toggleAutoScroll(); return; }
      uiVisible = !uiVisible;
      document.getElementById('ui-top').classList.toggle('hidden-top', !uiVisible);
      document.getElementById('ui-top').classList.toggle('hidden-ui', !uiVisible);
      document.getElementById('ui-bottom').classList.toggle('hidden-bot', !uiVisible);
      document.getElementById('ui-bottom').classList.toggle('hidden-ui', !uiVisible);
    }

    function toggleAutoScroll() {
      const btn = document.getElementById('auto-btn');
      const icon = document.getElementById('auto-icon');
      
      if (!isAuto) {
        // شروع اسکرول
        isAuto = true;
        icon.setAttribute('data-lucide', 'pause');
        btn.classList.add('btn-active-cyan');
        
        // پنهان سازی UI برای تمرکز بیشتر
        uiVisible = false;
        document.getElementById('ui-top').classList.add('hidden-top', 'hidden-ui');
        document.getElementById('ui-bottom').classList.add('hidden-bot', 'hidden-ui');
        
        timer = setInterval(() => {
          view.scrollBy(0, parseFloat(state.speed));
        }, 16);
      } else {
        // توقف اسکرول
        isAuto = false;
        icon.setAttribute('data-lucide', 'play');
        btn.classList.remove('btn-active-cyan');
        clearInterval(timer);
        
        // نمایش دوباره UI
        uiVisible = true;
        document.getElementById('ui-top').classList.remove('hidden-top', 'hidden-ui');
        document.getElementById('ui-bottom').classList.remove('hidden-bot', 'hidden-ui');
      }
      lucide.createIcons();
    }

    function updateHD(v) { state.hd = v; applyVisuals(); saveState(); }
    
    function setFilter(f) {
      const i = state.filters.indexOf(f);
      if (i > -1) state.filters.splice(i, 1); 
      else state.filters.push(f);
      applyVisuals(); saveState();
    }

    function initChapters() {
      const list = document.getElementById('ch-list');
      const search = document.getElementById('ch-search');
      const chapters = REMOTE.chaptersList || [];
      const currentNum = REMOTE.current_chapter.chapterNumber;

      const draw = (q = '') => {
        list.innerHTML = '';
        chapters.filter(c => c.chapterNumber.toString().includes(q)).forEach(ch => {
          const active = ch.chapterNumber === currentNum;
          const el = document.createElement('div');
          el.className = `flex items-center justify-between p-5 rounded-[1.8rem] border transition-all cursor-pointer ${active ? 'bg-cyan-500/10 border-cyan-500/30 text-cyan-400' : 'bg-white/5 border-transparent text-zinc-500 hover:bg-white/10 hover:text-white'}`;
          el.onclick = () => location.href = ch.chapterLink;
          el.innerHTML = `<span class="text-sm font-bold">Chapter ${ch.chapterNumber}</span><i data-lucide="chevron-left" class="w-4 h-4"></i>`;
          list.appendChild(el);
        });
        lucide.createIcons();
      };
      search.oninput = e => draw(e.target.value);
      draw();

      const idx = chapters.findIndex(c => c.chapterNumber === currentNum);
      document.getElementById('prev-ch').onclick = (e) => { 
          e.stopPropagation();
          if(idx > 0) location.href = chapters[idx-1].chapterLink; 
      };
      document.getElementById('next-ch').onclick = (e) => { 
          e.stopPropagation();
          if(idx < chapters.length-1) location.href = chapters[idx+1].chapterLink; 
      };
    }

    function toggleSettings() { 
      const el = document.getElementById('settings-panel');
      el.classList.toggle('hidden'); 
      el.classList.toggle('flex'); 
    }
    
    function toggleChapters() { 
      document.getElementById('ch-drawer').classList.toggle('translate-x-full'); 
    }
    
    function toggleReadMode() { 
      state.mode = state.mode === 'webtoon' ? 'book' : 'webtoon';
      state.width = state.mode === 'book' ? 1200 : 800;
      syncUI(); applyVisuals(); saveState();
    }

    window.onload = start;
  </script>
</body>
</html>
